{% extends "base.html" %}
{% block title %}Search Flights{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h1 class="mb-0">Find Your Flight</h1>
        </div>
        
        <div class="card-body">
            <form id="search-form" class="needs-validation" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="row g-3">
                    <!-- Origin -->
                    <div class="col-md-6">
                        <label for="origin" class="form-label">From</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-geo-alt"></i>
                            </span>
                            <input type="text" id="origin" name="origin" 
                                   class="form-control" 
                                   placeholder="Enter origin airport" 
                                   aria-label="Departure airport"
                                   required
                                   data-autocomplete="airport">
                            <div class="invalid-feedback">
                                Please select a departure airport
                            </div>
                        </div>
                        <div id="origin-suggestions" class="autocomplete-suggestions"></div>
                    </div>

                    <!-- Destination -->
                    <div class="col-md-6">
                        <label for="destination" class="form-label">To</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-geo-alt-fill"></i>
                            </span>
                            <input type="text" id="destination" name="destination" 
                                   class="form-control" 
                                   placeholder="Enter destination airport" 
                                   aria-label="Destination airport"
                                   required
                                   data-autocomplete="airport">
                            <div class="invalid-feedback">
                                Please select a destination airport
                            </div>
                        </div>
                        <div id="destination-suggestions" class="autocomplete-suggestions"></div>
                    </div>

                    <!-- Date Selection -->
                    <div class="col-md-6">
                        <label for="departure_date" class="form-label">Departure Date</label>
                        <input type="date" id="departure_date" name="departure_date" 
                               class="form-control" 
                               min="{{ datetime.now().strftime('%Y-%m-%d') }}"
                               required>
                    </div>

                    <!-- Passengers -->
                    <div class="col-md-6">
                        <label for="passengers" class="form-label">Passengers</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-people"></i>
                            </span>
                            <select class="form-select" id="passengers" name="passengers" required>
                                <option value="1">1 Adult</option>
                                <option value="2">2 Adults</option>
                                <option value="3">3 Adults</option>
                                <option value="4">4 Adults</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-search"></i> Search Flights
                    </button>
                </div>
            </form>

            <!-- Results Section -->
            <div class="mt-5" id="results-section">
                <!-- Loading State -->
                <div class="text-center py-4" id="loading-spinner" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Searching for flights...</p>
                </div>

                <!-- Error Message -->
                <div class="alert alert-danger mt-3" id="error-message" style="display: none;"></div>

                <!-- Main Results -->
                <div id="flight-results" class="row g-3 mt-3"></div>

                <!-- Alternative Flights -->
                <div id="alternative-flights" class="mt-5">
                    <h4 class="text-muted mb-4">Other Travel Options</h4>
                    <div class="row g-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .autocomplete-suggestions {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        background: white;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        z-index: 1000;
    }

    .autocomplete-suggestion {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background 0.2s;
    }

    .autocomplete-suggestion:hover {
        background: #f8f9fa;
    }

    .flight-card {
        border: 1px solid rgba(0,0,0,0.125);
        border-radius: 0.5rem;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .flight-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }

    .flight-price {
        font-size: 1.5rem;
        color: #0d6efd;
        font-weight: bold;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Airport Autocomplete
    const airportInputs = document.querySelectorAll('[data-autocomplete="airport"]');
    
    airportInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            const query = e.target.value;
            const suggestionsDiv = document.getElementById(`${input.id}-suggestions`);
            
            if (query.length < 2) {
                suggestionsDiv.innerHTML = '';
                return;
            }

            fetch(`/get_airports?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    suggestionsDiv.innerHTML = data.map(airport => `
                        <div class="autocomplete-suggestion" 
                             data-code="${airport.code}"
                             onclick="this.parentElement.previousElementSibling.value = '${airport.code}'; this.parentElement.innerHTML = ''">
                            <div class="fw-bold">${airport.code}</div>
                            <small class="text-muted">${airport.name}</small>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    showError('Failed to load airport suggestions');
                });
        });
    });

    // Form Submission
    document.getElementById('search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!this.checkValidity()) {
            this.classList.add('was-validated');
            return;
        }

        const formData = {
            origin: document.getElementById('origin').value,
            destination: document.getElementById('destination').value,
            departure_date: document.getElementById('departure_date').value,
            passengers: document.getElementById('passengers').value,
            csrf_token: document.querySelector('[name="csrf_token"]').value
        };

        // Validation
        if (formData.origin === formData.destination) {
            showError('Origin and destination cannot be the same');
            return;
        }

        toggleLoading(true);
        clearResults();

        fetch('/search_flights', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.csrf_token
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            displayResults(data);
        })
        .catch(error => {
            showError(error.message || 'Failed to search flights');
        })
        .finally(() => toggleLoading(false));
    });

    // Helper Functions
    function toggleLoading(show) {
        document.getElementById('loading-spinner').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    function clearResults() {
        document.getElementById('flight-results').innerHTML = '';
        document.getElementById('alternative-flights').querySelector('.row').innerHTML = '';
        document.getElementById('error-message').style.display = 'none';
    }

    function displayResults(data) {
        const formatTime = (timeStr) => new Date(timeStr).toLocaleTimeString([], { 
            hour: '2-digit', minute: '2-digit' 
        });

        // Main Results
        if (data.flights.length > 0) {
            const flightsHTML = data.flights.map(flight => `
                <div class="col-md-6">
                    <div class="flight-card p-3 mb-3 bg-white">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="mb-1">${flight.airline}</h5>
                                <small class="text-muted">${flight.flight_number}</small>
                            </div>
                            <div class="flight-price">
                                RM${flight.price}
                            </div>
                        </div>
                        
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="fw-bold">${flight.origin}</div>
                                <div class="text-muted">${formatTime(flight.departure_time)}</div>
                            </div>
                            <div class="col-6 text-end">
                                <div class="fw-bold">${flight.destination}</div>
                                <div class="text-muted">${formatTime(flight.arrival_time)}</div>
                            </div>
                        </div>
                        
                        <hr class="my-2">
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                ${flight.duration} • ${flight.seats_available} seats left
                            </small>
                            <a href="/book_flight/${flight.id}" class="btn btn-sm btn-primary">
                                Book Now <i class="bi bi-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('flight-results').innerHTML = `
                <h4 class="mb-4">${data.flights.length} Flights Found</h4>
                <div class="row g-3">${flightsHTML}</div>
            `;
        } else {
            document.getElementById('flight-results').innerHTML = `
                <div class="alert alert-info">
                    No flights found matching your criteria
                </div>
            `;
        }

        // Alternative Flights
        if (data.alternative_flights && data.alternative_flights.length > 0) {
            const altHTML = data.alternative_flights.map(flight => `
                <div class="col-md-4">
                    <div class="flight-card p-3 bg-light">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${flight.airline}</h6>
                                <small class="text-muted">${flight.flight_number}</small>
                            </div>
                            <div class="text-primary">
                                RM${flight.price}
                            </div>
                        </div>
                        <div class="small mt-2">
                            ${flight.origin} → ${flight.destination}<br>
                            ${formatTime(flight.departure_time)} - ${formatTime(flight.arrival_time)}
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.querySelector('#alternative-flights .row').innerHTML = altHTML;
        }
    }
});
</script>
{% endblock %}